name: RuboCop Lint
on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: false
        default: 'lint'
        type: string
      commit_sha:
        description: 'Commit SHA to approve (leave empty for current branch)'
        required: false
        type: string
  pull_request:
    types: [opened, reopened, synchronize]
  issue_comment:
    types: [created]
env:
  RAILS_ENV: test
  REPO_RUNTIME: 3.4.4-alpine3.21
  RAILS_NEXT: 0
jobs:
  rubocop:
    runs-on: ubuntu-latest
    if: >-
      ${{ github.event_name == 'pull_request' ||
          (github.event_name == 'issue_comment' &&
           github.event.issue.pull_request &&
           startsWith(github.event.comment.body, '/linters approve')) ||
          (github.event_name == 'workflow_dispatch' &&
           (contains(github.event.inputs.action, 'linters approve') || github.event.inputs.commit_sha != '')) }}

    permissions:
      packages: read
      contents: read
      checks: write
      statuses: read
      issues: read
      pull-requests: read
      id-token: write

    steps:
      - name: Check approval comment (from other user)
        id: check-approval
        if: github.event_name == 'issue_comment'
        run: |
          echo "üîç DEBUG: Processing issue comment approval"
          echo "üîç DEBUG: Comment body: '${{ github.event.comment.body }}'"
          echo "üîç DEBUG: Comment user: ${{ github.event.comment.user.login }}"

          # Get PR details to find the creator
          PR_URL="${{ github.event.issue.pull_request.url }}"
          echo "üîç DEBUG: Fetching PR data from: ${PR_URL}"

          PR_DATA=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                         -H "Accept: application/vnd.github.v3+json" \
                         "${PR_URL}")

          echo "üîç DEBUG: PR data response (first 500 chars):"
          echo "${PR_DATA}" | head -c 500

          # Extract PR creator and head SHA
          PR_CREATOR=$(echo "${PR_DATA}" | grep -A 10 '"user"' | grep '"login"' | head -n 1 | sed 's/.*"login": *"\([^"]*\)".*/\1/')
          PR_HEAD_SHA=$(echo "${PR_DATA}" | grep -A 10 '"head"' | grep '"sha"' | head -n 1 | sed 's/.*"sha": *"\([^"]*\)".*/\1/')
          COMMENT_USER="${{ github.event.comment.user.login }}"

          echo "üîç DEBUG: PR Creator extracted: ${PR_CREATOR}"
          echo "üîç DEBUG: PR Head SHA extracted: ${PR_HEAD_SHA}"
          echo "üîç DEBUG: Comment User: ${COMMENT_USER}"

          if [ "${COMMENT_USER}" = "${PR_CREATOR}" ]; then
            echo "‚ùå DEBUG: Self-approval not allowed (${COMMENT_USER} == ${PR_CREATOR})"
            exit 1
          else
            echo "‚úÖ DEBUG: Valid approval from different user"
            echo "approved=true" >> "$GITHUB_OUTPUT"
            echo "approver=${COMMENT_USER}" >> "$GITHUB_OUTPUT"
            echo "pr_head_sha=${PR_HEAD_SHA}" >> "$GITHUB_OUTPUT"
          fi

      - name: Check workflow dispatch approval
        id: dispatch-approval
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "üîç DEBUG: Workflow dispatch triggered"
          echo "üîç DEBUG: Action input: '${{ github.event.inputs.action }}'"
          echo "üîç DEBUG: Commit SHA input: '${{ github.event.inputs.commit_sha }}'"

          # Check if this is an approval dispatch (either by action text or commit SHA)
          if [[ "${{ github.event.inputs.action }}" == *"linters approve"* ]] || [[ -n "${{ github.event.inputs.commit_sha }}" ]]; then
            echo "‚úÖ DEBUG: Workflow dispatch approval detected"
            echo "approved=true" >> "$GITHUB_OUTPUT"
            echo "approver=${{ github.actor }}" >> "$GITHUB_OUTPUT"

            # Use provided commit SHA or default to current
            DISPATCH_SHA="${{ github.event.inputs.commit_sha || github.sha }}"
            echo "dispatch_sha=${DISPATCH_SHA}" >> "$GITHUB_OUTPUT"
            echo "üîç DEBUG: Workflow dispatch targeting SHA: ${DISPATCH_SHA}"
          else
            echo "‚ùå DEBUG: Regular workflow dispatch, not an approval"
            echo "approved=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Set regular PR mode
        id: pr-mode
        if: github.event_name == 'pull_request'
        run: |
          echo "approved=false" >> "$GITHUB_OUTPUT"

      - name: RuboCop approval success
        if: steps.check-approval.outputs.approved == 'true' || steps.dispatch-approval.outputs.approved == 'true'
        run: |
          # Determine approver from whichever step ran
          APPROVER="${{ steps.check-approval.outputs.approver || steps.dispatch-approval.outputs.approver }}"
          echo "üîç DEBUG: Approver determined as: ${APPROVER}"

          # Determine the correct SHA to look for check runs
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            TARGET_SHA="${{ steps.check-approval.outputs.pr_head_sha }}"
            echo "üîç DEBUG: Using PR head SHA for issue_comment: ${TARGET_SHA}"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TARGET_SHA="${{ steps.dispatch-approval.outputs.dispatch_sha }}"
            echo "üîç DEBUG: Using dispatch SHA for workflow_dispatch: ${TARGET_SHA}"
          else
            TARGET_SHA="${{ github.sha }}"
            echo "üîç DEBUG: Using github.sha for pull_request: ${TARGET_SHA}"
          fi

          # Find this check run to update it with pagination support
          echo "üîç DEBUG: Looking for 'rubocop' check run on commit: ${TARGET_SHA}"

          CHECK_RUN_ID=""
          PAGE=1

          while [ -z "${CHECK_RUN_ID}" ] && [ ${PAGE} -le 5 ]; do
            echo "üîç DEBUG: Fetching page ${PAGE} of check runs..."

            CHECK_RUNS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                             -H "Accept: application/vnd.github.v3+json" \
                             "https://api.github.com/repos/${{ github.repository }}/commits/${TARGET_SHA}/check-runs?per_page=100&page=${PAGE}")

            echo "üîç DEBUG: CHECK_RUNS response:"
            echo "${CHECK_RUNS}"

            # Look for failed rubocop check run (skip in_progress ones)
            echo "üîç DEBUG: Looking for failed rubocop check run..."

            # Find all check runs with conclusion "failure"
            FAILED_CHECKS=$(echo "${CHECK_RUNS}" | grep -B 10 -A 5 '"conclusion":"failure"')
            echo "üîç DEBUG: Failed checks found:"
            echo "${FAILED_CHECKS}" | head -c 500

            # From those, find the one with name "rubocop"
            CHECK_RUN_ID=$(echo "${FAILED_CHECKS}" | grep -B 15 '"name":"rubocop"' | grep '"id"' | tail -1 | sed 's/.*"id": *\([0-9]*\).*/\1/')
            echo "üîç DEBUG: Extracted failed rubocop check ID: ${CHECK_RUN_ID}"

            if [ -n "${CHECK_RUN_ID}" ]; then
              echo "‚úÖ DEBUG: Found rubocop check run ID: ${CHECK_RUN_ID} on page ${PAGE}"
              break
            fi

            # Check if there are more pages
            TOTAL_COUNT=$(echo "${CHECK_RUNS}" | grep '"total_count"' | sed 's/.*"total_count": *\([0-9]*\).*/\1/')
            CURRENT_COUNT=$((PAGE * 100))

            echo "üîç DEBUG: Page ${PAGE} - Total: ${TOTAL_COUNT}, Current: ${CURRENT_COUNT}"

            if [ "${CURRENT_COUNT}" -ge "${TOTAL_COUNT}" ]; then
              echo "üîç DEBUG: No more pages to check"
              break
            fi

            PAGE=$((PAGE + 1))
          done

          if [ -n "${CHECK_RUN_ID}" ]; then
            echo "üîç DEBUG: Updating check run ${CHECK_RUN_ID} with approval info..."

            # Update check run with approval info
            UPDATE_RESPONSE=$(curl -s -X PATCH \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/repos/${{ github.repository }}/check-runs/${CHECK_RUN_ID}" \
              -d "{
                \"conclusion\": \"success\",
                \"output\": {
                  \"title\": \"‚úÖ RuboCop approved by ${APPROVER}\",
                  \"summary\": \"RuboCop check manually approved by @${APPROVER}\\n\\nLinting was bypassed - ensure code quality through manual review.\"
                }
              }")

            echo "üîç DEBUG: Update response:"
            echo "${UPDATE_RESPONSE}"

            if echo "${UPDATE_RESPONSE}" | grep -q '"conclusion":"success"'; then
              echo "‚úÖ Successfully updated check run!"
            else
              echo "‚ùå Failed to update check run"
            fi
          else
            echo "‚ùå DEBUG: Could not find RuboCop Lint check run ID"
          fi

      - name: Add reaction to approval comment
        if: steps.check-approval.outputs.approved == 'true'
        run: |
          echo "üîç DEBUG: Adding rocket reaction to comment"
          echo "üîç DEBUG: Comment ID: ${{ github.event.comment.id }}"
          echo "üîç DEBUG: Repository: ${{ github.repository }}"

          REACTION_RESPONSE=$(curl -s -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/comments/${{ github.event.comment.id }}/reactions" \
            -d '{"content": "rocket"}')

          echo "üîç DEBUG: Reaction API response:"
          echo "${REACTION_RESPONSE}"

          if echo "${REACTION_RESPONSE}" | grep -q '"content":"rocket"'; then
            echo "‚úÖ Successfully added rocket reaction!"
          else
            echo "‚ùå Failed to add rocket reaction"
          fi

      - name: Check out repository
        if: github.event_name == 'pull_request'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Ruby
        if: github.event_name == 'pull_request'
        uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true

      - name: Run RuboCop only on changed lines
        if: github.event_name == 'pull_request'
        run: |
          echo "Running RuboCop on changed lines vs. master"
          bundle exec rubocop
