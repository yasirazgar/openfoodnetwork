name: RuboCop Lint
on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: false
        default: 'lint'
        type: string
  pull_request:
    types: [opened, reopened, synchronize]
  issue_comment:
    types: [created]
env:
  RAILS_ENV: test
  REPO_RUNTIME: 3.4.4-alpine3.21
  RAILS_NEXT: 0
jobs:
  rubocop:
    runs-on: ubuntu-22.04
    if: >-
      ${{ github.event_name == 'pull_request' ||
          (github.event_name == 'issue_comment' &&
           github.event.issue.pull_request &&
           startsWith(github.event.comment.body, '/linters approve')) ||
          (github.event_name == 'workflow_dispatch' &&
           contains(github.event.inputs.action, 'linters approve')) }}

    permissions:
      packages: read
      contents: read
      checks: write
      statuses: read
      issues: read
      pull-requests: read
      id-token: write    

    steps:
      - name: Check approval comment (from other user)
        id: check-approval
        if: github.event_name == 'issue_comment'
        run: |
          # Get PR details to find the creator
          PR_URL="${{ github.event.issue.pull_request.url }}"
          PR_DATA=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                         -H "Accept: application/vnd.github.v3+json" \
                         "${PR_URL}")

          # Extract PR creator
          PR_CREATOR=$(echo "${PR_DATA}" | grep -A 10 '"user"' | grep '"login"' | head -n 1 | sed 's/.*"login": *"\([^"]*\)".*/\1/')
          COMMENT_USER="${{ github.event.comment.user.login }}"

          if [ "${COMMENT_USER}" = "${PR_CREATOR}" ]; then
            echo "Self-approval not allowed"
            exit 1
          else
            echo "approved=true" >> "$GITHUB_OUTPUT"
            echo "approver=${COMMENT_USER}" >> "$GITHUB_OUTPUT"
          fi

      - name: Check workflow dispatch approval
        id: dispatch-approval
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "approved=true" >> "$GITHUB_OUTPUT"
          echo "approver=${{ github.actor }}" >> "$GITHUB_OUTPUT"

      - name: Set regular PR mode
        id: pr-mode
        if: github.event_name == 'pull_request'
        run: |
          echo "approved=false" >> "$GITHUB_OUTPUT"

      - name: RuboCop approval success
        if: steps.check-approval.outputs.approved == 'true' || steps.dispatch-approval.outputs.approved == 'true'
        run: |
          # Determine approver from whichever step ran
          APPROVER="${{ steps.check-approval.outputs.approver || steps.dispatch-approval.outputs.approver }}"
          
          # Find this check run to update it
          CHECK_RUNS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                           -H "Accept: application/vnd.github.v3+json" \
                           "https://api.github.com/repos/${{ github.repository }}/commits/${{ github.sha }}/check-runs")

          CHECK_RUN_ID=$(echo "${CHECK_RUNS}" | grep -A10 -B10 '"name":"RuboCop Lint"' | grep '"id"' | head -1 | sed 's/.*"id": *\([0-9]*\).*/\1/')

          if [ -n "${CHECK_RUN_ID}" ]; then
            # Update check run with approval info
            curl -X PATCH \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/repos/${{ github.repository }}/check-runs/${CHECK_RUN_ID}" \
              -d "{
                \"conclusion\": \"success\",
                \"output\": {
                  \"title\": \"âœ… RuboCop approved by ${APPROVER}\",
                  \"summary\": \"RuboCop check manually approved by @${APPROVER}\\n\\nLinting was bypassed - ensure code quality through manual review.\"
                }
              }"
          fi

      - name: Add reaction to approval comment
        if: steps.check-approval.outputs.approved == 'true'
        run: |
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/comments/${{ github.event.comment.id }}/reactions" \
            -d '{"content": "rocket"}'

      - name: Check out repository
        if: github.event_name == 'pull_request'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true

      - name: Run RuboCop only on changed lines
        if: github.event_name == 'pull_request'
        run: |
          echo "Running RuboCop on changed lines vs. master"
          bundle exec rubocop
